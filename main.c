#include <avr/io.h>
#include <avr/pgmspace.h>

#define outLow(port,pin) port &= ~(1<<pin)
#define outHigh(port,pin) port |= (1<<pin)
#define outToggle(port,pin) port ^= (1<<pin)
#define setIn(portdir,pin) portdir &= ~(1<<pin)
#define setOut(portdir,pin) portdir |= (1<<pin)

const uint8_t freq[] PROGMEM =  {
		113, 113, 113, 147, 113, 97, 197, 147, 197, 234, 170, 156,
		166, 174, 197, 113, 98, 87, 107, 98, 113, 144, 129, 156,
		147, 197, 234, 170, 156, 166, 174, 197, 113, 98, 87, 107,
		98, 113, 144, 129, 156, 150, 98, 104, 110, 120, 115, 197,
		174, 150, 174, 150, 131, 150, 98, 104, 110, 120, 115, 73,
		73, 73, 197, 150, 98, 104, 110, 120, 115, 197, 174, 150,
		174, 150, 131, 128, 136, 150, 197, 150, 150, 150, 150,
		98, 104, 110, 120, 115, 197, 174, 150, 174, 150, 131,
		150, 98, 104, 110, 120, 115, 73, 73, 73, 197, 150, 98,
		104, 110, 120, 115, 197, 174, 150, 174, 150, 131, 128, 136,
		150, 197, 150, 150, 150, 150, 150, 150, 150, 129, 113, 150,
		174, 197, 150, 150, 150, 150, 129, 113, 86, 98, 150, 150,
		150, 150, 129, 113, 150, 174, 197, 113, 113, 113, 147,
		113, 97, 197
};

const uint8_t length[] PROGMEM = {
		100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 80, 100,
		100, 100, 80, 50, 100, 80, 50, 80, 80, 80, 80, 100, 100, 100,
		100, 80, 100, 100, 100, 80, 50, 100, 80, 50, 80, 80, 80, 80,
		100, 100, 100, 100, 150, 150, 100, 100, 100, 100, 100, 100,
		100, 100, 100, 100, 150, 200, 80, 80, 80, 100, 100, 100, 100,
		100, 150, 150, 100, 100, 100, 100, 100, 100, 100, 100, 100,
		100, 100, 100, 100, 100, 100, 100, 100, 150, 150, 100, 100,
		100, 100, 100, 100, 100, 100, 100, 100, 150, 200, 80, 80, 80,
		100, 100, 100, 100, 100, 150, 150, 100, 100, 100, 100, 100, 100,
		100, 100, 100, 100, 100, 100, 100, 60, 80, 60, 80, 80, 80, 80,
		80, 80, 60, 80, 60, 80, 80, 80, 80, 80, 60, 80, 60, 80, 80, 80,
		80, 80, 80, 100, 100, 100, 100, 100, 100, 100
};

const int delay[] PROGMEM = {
		150, 300, 300, 100, 300, 550, 575, 450, 400, 500, 300, 330,
		150, 300, 200, 200, 150, 300, 150, 350, 300, 150, 150, 500,
		450, 400, 500, 300, 330, 150, 300, 200, 200, 150, 300, 150,
		350, 300, 150, 150, 500, 300, 100, 150, 150, 300, 300, 150,
		150, 300, 150, 100, 220, 300, 100, 150, 150, 300, 300, 300,
		150, 300, 300, 300, 100, 150, 150, 300, 300, 150, 150, 300,
		150, 100, 420, 450, 420, 360, 300, 300, 150, 300, 300, 100,
		150, 150, 300, 300, 150, 150, 300, 150, 100, 220, 300, 100,
		150, 150, 300, 300, 300, 150, 300, 300, 300, 100, 150, 150,
		300, 300, 150, 150, 300, 150, 100, 420, 450, 420, 360, 300,
		300, 150, 300, 150, 300, 350, 150, 350, 150, 300, 150, 600,
		150, 300, 350, 150, 150, 550, 325, 600, 150, 300, 350, 150,
		350, 150, 300, 150, 600, 150, 300, 300, 100, 300, 550, 575
};

void sleep(int ms) {
	int cnt;

	for (cnt=0; cnt<(ms); cnt++) {
		int i = 150;

		while(i--) {
			__asm("NOP");
		}
	}
}

int main(void) {
	uint8_t cnt;

	setOut(DDRD,PD6); //speaker

	TCCR0A |= (1<<WGM01);  // configure timer 1 for CTC mode
	TCCR0A |= (1<<COM0A0); // toggle OC0A on compare match
	TCCR0B |= (1<<CS01);   // clk/8 prescale

	for (;;) {
		for (cnt=0; cnt<156; cnt++) {
			OCR0A = pgm_read_byte(&freq[cnt]);
			sleep(pgm_read_byte(&length[cnt]));

			// stop timer
			TCCR0B = 0;
			sleep (pgm_read_word(&delay[cnt]));

			// start timer
			TCCR0B |= (1<<CS01);   // clk/8 prescale
		}
	}

	return 0;
}
